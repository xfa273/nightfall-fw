# Nightfall FW 開発運用方針（暫定）

このドキュメントは、`nightfall-fw`（今後のメインファームウェア）へ移行し、`mini_v1_1` と `classic_v2` を **共通コード + params差分のみ**で運用するための方針をまとめたものです。

（現時点では `micromouse/` 直下に置き、`nightfall-fw` 作成後に `nightfall-fw/docs/` へ移設する想定です。）

---

## 1. 目標

- `mini_v1_1` をメインに開発しつつ、`classic_v2` にも自動的に反映される構造にする
- `mini_v1_1` と `classic_v2` の差分は **paramsのみ**（ハード側で挙動を合わせる）
- 生成物（ELF/BIN）は **両方**を常にビルドできるようにする（壊れ検知を早くする）

---

## 2. リポジトリと命名

- メインリポジトリ名: `nightfall-fw`
- 機体（variant）名:
  - `mini_v1_1`
  - `classic_v2`
- CMakeターゲット名（例）:
  - `nightfall_mini_v1_1`
  - `nightfall_classic_v2`

---

## 3. ディレクトリ構成（推奨）

STM32F405 を共通で使う前提なので、platform（CubeMX生成物/HAL/startup/ld）は共通化します。

- `common/`
  - 迷路探索、経路導出、制御ロジック、共通ユーティリティ
- `app/`
  - アプリ層（状態機械など）。基本は共通
- `platform/stm32f405/`
  - CubeMX生成物、HAL、startup、リンカスクリプト
- `params/<variant>/`
  - 機体差分（paramsのみ）
- `tools/`
  - 書き込み等の補助ツール（例: `flash_uart`）
- `docs/`
  - 運用ドキュメント、ビルド手順

---

## 4. バージョニング（3層に分ける）

### 4.1 HW Rev（基板の版）

- 基板・配線・部品変更を表す版
- 例:
  - `mini: HW r1.1`
  - `classic: HW r0.1`

ルール:
- **基板が変わったら必ず上げる**（シルク/メモに残す）

### 4.2 FW Version（共通ファームの版）

- 共通コード（探索/経路導出/制御枠組み/ログ/通信など）の版
- SemVer（`MAJOR.MINOR.PATCH`）を採用

ルール（推奨）:
- **MAJOR**: 互換性が壊れる変更
  - params項目の意味/単位が変わる
  - ログ/通信/設定の形式が壊れる
  - モード体系や状態遷移の前提が変わる
- **MINOR**: 後方互換を保った機能追加・改善
- **PATCH**: バグ修正

補足:
- 「機能追加が大きい」こと自体をMAJORにするより、**互換性の有無**でMAJOR/MINORを決める方が後で混乱しにくいです。

### 4.3 Params/Tune Version（機体ごとの調整版）

- 目的は互換性より **再現性**（どの調整で走ったか）
- `params/<variant>/` ごとに独立して版を管理

ルール（推奨）:
- 走りの挙動が変わったら上げる（例: `v1.4 -> v1.5`）
- 思想が変わるレベルなら大きく上げる（例: `v1.x -> v2.0`）

---

## 5. ブランチ運用（実験を前提にしたルール）

### 5.1 基本ブランチ

- `main`:
  - いつでもビルドでき、既知の動作を維持するブランチ
- `feature/<topic>`:
  - 採用予定の開発（成功したら `main` へマージ）
- `fix/<topic>`:
  - バグ修正
- `exp/<topic>`:
  - 成功するか不明な実験（WIPを含む）

### 5.2 実験（exp）の進め方

- 実験は `exp/<topic>` ブランチで行う
- **「戻したい粒度」でコミットを切る**
  - 途中で動かなくてもコミットしてOK（後で戻すため）
- 実験の状態が分かるように命名する

命名例:
- `exp/poscorr-20251229`
- `exp/poscorr-try1`

推奨（より管理しやすい）:
- `exp/<topic>/<yyyyMMdd>-<short>` 形式
  - 例: `exp/poscorr/20251229-try1`

### 5.3 実験が成功した場合

- `exp/*` を `feature/*` に寄せる（またはそのままPR作成でも可）
- `main` にマージする
- `main` で必要に応じて `FW vX.Y.Z` のタグを付ける（採用された時点のみ）

### 5.4 実験が失敗した（没になった）場合の扱い

方針:
- **没は残したい**（再挑戦や参照のため）
- ただし、没ブランチが増えすぎると可視性が落ちる

そこで「残す」ための方法を2段階にします。

#### ステップ1（短期保管）：没ブランチを残す

- 失敗が確定したらブランチ名に状態を入れる（分かりやすさ優先）
  - 例: `exp/poscorr/20251229-try1__abandoned`
- そのブランチは `main` へはマージしない

#### ステップ2（棚卸し/長期保管）：タグ化してブランチは消す（推奨）

「残す」は **ブランチである必要はなく、参照できれば十分**なことが多いです。
長期的に見通しを良くするため、一定期間で整理します。

- 例：四半期ごとに棚卸し
- 残したい没は、最終コミットにタグを打つ
  - 例: `abandoned/poscorr/20251229-try1`
- タグを付けたら、没ブランチは削除する（タグから復元できる）

この方式だと:
- 参照性（履歴は残る）
- 見通し（ブランチ一覧が荒れない）
を両立できます。

#### 例外（ブランチを残し続ける）

次に該当するものは、没でもブランチのまま残して良いです。
- 近いうちに再挑戦する予定が高い
- 動作はダメだったが、実装部品として価値が高く、再利用したい

### 5.5 実験の一覧性（推奨）

没/成功を含め「何を試したか」が後で追えるように、`docs/EXPERIMENT_LOG.md` のような一覧を作るのがおすすめです。
最低限、以下の情報だけで十分です。

- topic
- 目的
- 結果（成功/失敗）
- 参照（ブランチ名 or タグ名 or コミットID）
- メモ（なぜ失敗したか）

### 5.6 ローカル作業のバックアップ運用（標準：案2）

目的:
- 「戻したい状態が保存されていない」を無くす
- “動いたらコミット”に頼らず、途中経過も含めてGitHubへ残す

運用ルール（必須）:
- 作業は原則ブランチで行う（`feature/*`, `fix/*`, `exp/*`）
- ブランチを切ったら **早い段階で1回push** する（GitHubにバックアップを作る）
- WIPでもコミットして良い（例: `wip: ...`）
- pushタイミングは「判断」ではなく、以下で固定する
  - 目安: 15〜30分に1回（進捗があれば）
  - 危ない変更の前（大きいリファクタ、生成系、CMake、ファイル大量変更など）
  - 作業終了前（その日の終わり）

推奨:
- ブランチを作ったら GitHub で **Draft PR** を作り、作業ログ兼バックアップとして運用する
  - PRは「完成してから作る」ではなく、開始直後から作る

`git wip` エイリアス（推奨）:
- `git wip <message>` で `add -A` →（変更があれば）`commit` → `push` を1発で行う
- コマンド（リポジトリ内ローカル設定）:
  - `git config alias.wip '!f(){ msg="${1:-checkpoint}"; git add -A && (git diff --cached --quiet || git commit -m "wip: ${msg}") && git push; }; f'`
- 補足:
  - エイリアスはこのリポジトリにのみ有効（他リポジトリでも使いたい場合は `--global` を付ける）
  - 変更が無い場合はcommitせずにpushだけ実行する

---

## 6. リリース（タグ付け）のルール

- `vX.Y.Z` は **mainに入ったものだけ**に付ける
- 実験中のチェックポイントにタグを付けたい場合は、`v` 形式ではなく別プレフィックスを使う
  - 例: `exp/poscorr/try1-checkpoint-a`

---

## 7. 「どのビルドを実機に入れたか」を確実にする（推奨）

SemVerを細かく上げるより、ファームにビルド識別子を埋め込む方が運用が楽です。

- 推奨: `git describe` 由来の文字列をファーム内に埋め込み、起動ログ等で出せるようにする
- 目的: 実機テスト結果とソースを1対1で紐付ける

（これは `nightfall-fw` 側のCMake整備フェーズで実装します。）

---

## 8. 移行手順（順番）

1. `nightfall-fw` を新規作成（空repo）
2. 上記のディレクトリ構成を作成
3. まず `mini_v1_1` がビルド・書き込みできる状態まで移植（この時点ではcommon化を急がない）
4. 共通化対象を `common/` へ段階的に移動
5. `classic_v2` を追加し、`params/classic_v2` を作成（差分はparamsのみ）
6. 常に両方がビルドできる状態を維持

---

## 9. 決め（今回合意した内容）

- STM32F405 は mini/classic で共通
- 差分は params のみ（ハード側で挙動を合わせる）
- 生成物は両方作る
- 没機能は残すが、長期的には **タグ化してブランチを整理**する
